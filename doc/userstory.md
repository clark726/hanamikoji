# 使用者故事 (User Stories)

## 房間管理系統

### US-001: 玩家自動加入房間
**作為** 玩家  
**我想要** 點擊開始遊戲後自動進入房間  
**這樣我就** 不需要手動選擇或創建房間  

**驗收標準：**
- [x] 玩家點擊開始遊戲按鈕
- [x] 系統自動檢查是否有等待中的房間
- [x] 如果有可用房間，自動加入
- [x] 如果沒有可用房間，自動創建新房間
- [x] 顯示房間狀態給玩家

**API端點：** `POST /api/v1/rooms/join`

---

### US-002: 自動房間分配邏輯
**作為** 系統  
**我需要** 智能地分配玩家到合適的房間  
**這樣我就** 能提供流暢的遊戲體驗  

**業務規則：**
1. **玩家重複加入檢查**
   - 檢查玩家是否已在其他房間
   - 如果已在房間中，返回錯誤訊息
   
2. **房間搜尋邏輯**
   - 搜尋狀態為 `waiting` 的房間
   - 選擇未滿員的房間（< 2人）
   - 按創建時間排序，優先加入較早的房間

3. **新房間創建**
   - 沒有可用房間時自動創建
   - 房間ID格式：`room_` + 8位隨機字符
   - 初始狀態為 `waiting`

**驗收標準：**
- [x] 玩家不能同時在多個房間
- [x] 優先填滿現有房間再創建新房間
- [x] 房間創建後立即可用

---

### US-003: 房間狀態自動管理
**作為** 系統  
**我需要** 自動管理房間的生命週期  
**這樣我就** 能確保遊戲流程的順暢運行  

**房間狀態流程：**
```
waiting (0-1人) → starting (2人) → playing (遊戲中) → finished (遊戲結束)
                ↓
            abandoned (玩家離開)
```

**狀態轉換規則：**
1. **waiting → starting**
   - 觸發條件：房間達到2人
   - 自動觸發：是
   
2. **starting → playing**
   - 觸發條件：遊戲成功創建
   - 需要遊戲ID關聯
   
3. **waiting/starting → abandoned**
   - 觸發條件：所有玩家離開
   - 房間標記為廢棄

**驗收標準：**
- [x] 房間滿員時自動變為 `starting` 狀態
- [x] 遊戲開始時房間變為 `playing` 狀態
- [x] 玩家離開時正確更新房間狀態
- [x] 空房間自動標記為 `abandoned`

---

### US-004: 自動遊戲開始
**作為** 玩家  
**我想要** 房間滿員後自動開始遊戲  
**這樣我就** 不需要額外的操作等待  

**遊戲開始流程：**
1. 房間達到2人，狀態變為 `starting`
2. 系統自動調用遊戲創建API
3. 遊戲創建成功後返回 `game_id`
4. 房間關聯 `game_id`，狀態變為 `playing`
5. 通知所有玩家遊戲開始

**驗收標準：**
- [x] 房間滿員後5秒內自動開始遊戲
- [x] 所有玩家收到遊戲開始通知
- [x] 房間正確關聯到遊戲ID
- [x] 玩家自動跳轉到遊戲界面

**API整合：**
- 房間API：`POST /api/v1/rooms/join`
- 遊戲API：`POST /api/v1/games/create`
- WebSocket：房間事件通知

---

### US-005: 玩家離開房間
**作為** 玩家  
**我想要** 能夠在等待時離開房間  
**這樣我就** 可以取消不想進行的遊戲  

**離開房間規則：**
1. **允許離開的情況**
   - 房間狀態為 `waiting` 或 `starting`
   - 遊戲尚未開始

2. **不允許離開的情況**
   - 房間狀態為 `playing`
   - 遊戲進行中

3. **離開後處理**
   - 從房間玩家列表移除
   - 如果房間變空，標記為 `abandoned`
   - 通知其他玩家

**驗收標準：**
- [x] 等待中的玩家可以成功離開房間
- [x] 遊戲中的玩家無法離開房間
- [x] 離開後其他玩家收到通知
- [x] 空房間正確標記為廢棄狀態

**API端點：** `DELETE /api/v1/rooms/{room_id}/leave`

---

### US-006: 房間狀態即時同步
**作為** 玩家  
**我想要** 即時看到房間狀態變化  
**這樣我就** 能了解當前遊戲進度  

**即時通知事件：**
1. **玩家加入房間** (`player_joined`)
   - 通知：新玩家資訊
   - 房間當前人數
   
2. **玩家離開房間** (`player_left`)
   - 通知：離開玩家資訊
   - 房間剩餘人數
   
3. **遊戲開始** (`game_started`)
   - 通知：遊戲ID
   - 玩家資訊
   - 遊戲跳轉指示

**驗收標準：**
- [x] 房間內所有事件即時推送
- [x] 玩家收到正確的狀態更新
- [x] WebSocket連接穩定可靠
- [x] 斷線重連機制

**WebSocket端點：** `ws://localhost:8080/ws/room/{room_id}`

---

### US-007: 簡化遊戲入口
**作為** 玩家  
**我想要** 一鍵開始遊戲而不需要選擇房間  
**這樣我就** 能快速進入遊戲體驗  

**簡化流程：**
1. **一鍵開始**
   - 點擊開始遊戲
   - 系統自動分配房間
   - 直接進入等待界面

2. **自動匹配**
   - 無需瀏覽房間列表
   - 無需手動選擇房間
   - 系統智能分配

**驗收標準：**
- [x] 首頁只有開始遊戲按鈕
- [x] 點擊後直接進入房間
- [x] 無房間選擇界面
- [x] 流程簡潔明確

---

## 錯誤處理用戶故事

### US-008: 房間滿員處理
**作為** 玩家  
**當我嘗試加入已滿的房間時**  
**我應該** 收到友善的錯誤訊息並提供替代方案  

**錯誤回應：**
```json
{
  "error": "RoomFull",
  "message": "房間已滿",
  "available_rooms": ["room_123456"]
}
```

### US-009: 重複加入房間處理
**作為** 玩家  
**當我已在房間中又嘗試加入時**  
**我應該** 收到提示並回到當前房間  

**錯誤回應：**
```json
{
  "error": "PlayerAlreadyInRoom",
  "message": "玩家已在其他房間中",
  "current_room": "room_123456"
}
```

---

## 技術實現要求

### 資料一致性
- 使用MongoDB事務確保房間狀態一致性
- 樂觀鎖避免併發衝突
- 定期清理廢棄房間

### 性能要求
- 房間加入響應時間 < 500ms
- WebSocket事件推送延遲 < 100ms
- 支援至少100個併發房間

### 可擴展性
- 支援調整最大房間人數
- 支援不同遊戲模式的房間
- 支援房間私有化功能（未來擴展）